var B = Object.defineProperty;
var _ = (s, o, t) => o in s ? B(s, o, { enumerable: !0, configurable: !0, writable: !0, value: t }) : s[o] = t;
var n = (s, o, t) => (_(s, typeof o != "symbol" ? o + "" : o, t), t);
class g extends HTMLElement {
  setStyles(o) {
    Object.keys(o).forEach((e) => {
      this.style[e] = o[e];
    });
  }
}
const u = "onbotgo-bubble";
class C extends g {
  constructor() {
    super(), this.innerHTML = `
      <svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
    `;
  }
}
C.tag = u;
const $ = (s) => ({
  [u]: {
    display: "grid",
    "place-items": "center",
    width: "48px",
    height: "48px",
    "background-color": s.colors.primary,
    fill: "transparent",
    "border-radius": "100px",
    transition: "transform 0.1s linear"
  },
  [`${u}:hover`]: {
    transform: "scale(1.1)"
  },
  [`${u} > svg`]: {
    width: "28px",
    height: "28px",
    stroke: "white",
    "stroke-width": "2px",
    "border-image-width": "2"
  }
}), I = "onbotgo-box";
class h extends g {
  constructor() {
    super(), this.setStyles({ display: "inline-block", width: "100%" });
  }
}
h.tag = I;
const y = "onbotgo-chatinput";
class v extends g {
  constructor() {
    super();
    n(this, "defaultStyles", {
      height: "8%",
      width: "100%",
      display: "grid",
      gridTemplateColumns: "10fr 1fr",
      alignItems: "center",
      boxShadow: "0 2px 6px -1px rgba(0,0,0,.1)"
    });
    n(this, "input", document.createElement("input"));
    n(this, "sendIcon", new h());
    this.setStyles(this.defaultStyles), this.input, this.input.type = "text", this.input.placeholder = "Escribe un mensaje", this.sendIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="19px" class="send-icon flex " ><path d="M476.59 227.05l-.16-.07L49.35 49.84A23.56 23.56 0 0027.14 52 24.65 24.65 0 0016 72.59v113.29a24 24 0 0019.52 23.57l232.93 43.07a4 4 0 010 7.86L35.53 303.45A24 24 0 0016 327v113.31A23.57 23.57 0 0026.59 460a23.94 23.94 0 0013.22 4 24.55 24.55 0 009.52-1.93L476.4 285.94l.19-.09a32 32 0 000-58.8z"></path></svg>', this.appendChild(this.input), this.appendChild(this.sendIcon);
  }
  onSubmit(t) {
    this.sendIcon.onclick = (e) => t(this.input.value), this.input.onkeydown = (e) => {
      ["13", "Enter"].includes(e.key) && (t(this.input.value), this.input.value = "");
    };
  }
}
v.tag = y;
const M = (s) => ({
  [`${y} > input`]: {
    "border-radius": "6px",
    outline: "none",
    border: "none",
    height: "100%",
    padding: "0 10px"
  },
  [`${y} svg`]: {
    cursor: "pointer",
    fill: s.colors.primary
  }
});
class L {
  constructor() {
    n(this, "typography", {
      primary: "'Trebuchet MS', sans-serif"
    });
    n(this, "colors", { primary: "rgb(59, 129, 246)" });
  }
}
const d = new L(), f = "onbotgo-chatmessage";
class m extends g {
  constructor(t) {
    super();
    n(this, "messageBox", new h());
    this.setStyles({
      width: "100%",
      display: "flex",
      minHeight: "max(45px,fit-content)",
      justifyContent: t.type === "userMessage" ? "flex-end" : "flex-start"
    });
    const e = {
      userMessage: "from-user",
      apiMessage: "from-chatbot"
    };
    if (this.messageBox.setStyles({
      width: "fit-content",
      height: "fit-content",
      borderRadius: "6px",
      display: "flex",
      alignItems: "center",
      padding: "15px 15px",
      fontFamily: d.typography.primary,
      color: t.type === "userMessage" ? "white" : "black"
    }), this.messageBox.classList.add(e[t.type]), this.messageBox.innerText = t.message, t.type !== "userMessage") {
      const i = new h();
      i.classList.add("bg-semi-transp"), this.messageBox.appendChild(i);
    }
    this.appendChild(this.messageBox);
  }
}
m.tag = f;
const j = (s) => ({
  [`${f} > .from-chatbot`]: {
    width: "100%",
    content: "",
    overflow: "hidden",
    position: "relative",
    "max-width": "75%",
    "z-index": 1
  },
  [`${f} > .from-chatbot > .bg-semi-transp`]: {
    position: "absolute",
    width: "100%",
    height: "100%",
    opacity: ".1",
    top: 0,
    "z-index": "-1",
    left: 0,
    "background-color": s.colors.primary
  },
  [`${m.tag} > .from-user`]: {
    "margin-right": "15px",
    "max-width": "70%",
    "background-color": s.colors.primary
  }
});
class O {
  constructor() {
    n(this, "gpt_url", "https://api-whatsapp-dev.mibot.cl:7070");
    n(this, "chatflowID", "");
  }
}
const x = new O(), R = async (s) => await fetch(
  `${x.gpt_url}/v1/internal-prediction/${x.chatflowID}`,
  {
    headers: {
      "Content-Type": "application/json"
    },
    method: "POST",
    body: JSON.stringify(s)
  }
).then((o) => o.json());
class E extends HTMLElement {
  constructor(t) {
    super();
    n(this, "container");
  }
  connectedCallback() {
    this.attachShadow({ mode: "open" }), this.targetElId = this.dataset.targetId, this.trackColor = this.dataset.trackColor || "#f2f2f2", this.trackWidth = this.dataset.trackWidth || "6px", this.thumbColor = this.dataset.thumbColor || "#c1c1c1", this.targetEl = document.querySelector("#onbotgo-messageContainer");
    const t = document.createElement("style");
    if (t.textContent = `
        .custom-scrollbar {
          width: ${this.trackWidth};
          height: 100%;
          position: absolute;
          top: 0;
          right: 0;
        }
  
        .custom-scrollbar__track {
          width: 100%;
          height: 100%;
          background-color: ${this.trackColor};
        }
  
        .custom-scrollbar__thumb {
          width: 100%;
          background-color: ${this.thumbColor};
          border-radius: ${this.trackWidth};
          position: absolute;
          top: 0;
          animation: top 0.25s ease-in;
  
        }
  
        .custom-scrollbar__thumb:hover {
          background-color: red;
        }
      `, this.shadowRoot.appendChild(t), !this.targetEl) {
      console.warn(
        `CustomScrollBar: target element with id "${this.targetElId}" not found`,
        this,
        this.dataset.targetId
      );
      return;
    }
    new IntersectionObserver((i) => {
      i.forEach((r) => {
        r.isIntersecting && (this.setTargetElCSS(), this.setScrollThumbHeight());
      });
    }).observe(this.targetEl), this.shadowRoot.innerHTML += `
        <div class="custom-scrollbar">
          <div class="custom-scrollbar__track">
            <div class="custom-scrollbar__thumb"></div>
          </div>
        </div>
      `, this.targetEl.addEventListener("scroll", () => {
      this.moveScrollThumb();
    });
  }
  moveScrollThumb() {
    const t = this.shadowRoot.querySelector(
      ".custom-scrollbar__thumb"
    ), e = this.shadowRoot.querySelector(
      ".custom-scrollbar__track"
    ).offsetHeight, i = this.targetEl.scrollTop / this.targetEl.scrollHeight * e;
    t.style.top = `${i}px`;
  }
  setTargetElCSS() {
    this.targetEl.style.overflowY = "scroll", this.targetEl.style.position = "relative", this.targetEl.style["-ms-overflow-style"] = "none", this.targetEl.style.scrollbarWidth = "none";
  }
  setScrollThumbHeight() {
    const t = this.shadowRoot.querySelector(
      ".custom-scrollbar__track"
    ), e = this.shadowRoot.querySelector(
      ".custom-scrollbar__thumb"
    ), i = t.offsetHeight, r = this.targetEl.offsetHeight, a = this.targetEl.scrollHeight, b = r / a * i;
    e.style.height = `${b}px`;
    let l = !1, c;
    e.addEventListener("mousedown", (p) => {
      l = !0, c = p.clientY, this.preventContentHighlight("remove");
    }), document.addEventListener("mouseup", () => {
      l = !1, this.preventContentHighlight("add");
    }), document.addEventListener("mousemove", (p) => {
      if (!l)
        return;
      const H = p.clientY - c;
      c = p.clientY, this.targetEl.scrollTop += H * (a / i);
    });
  }
  // prevent content highlight when dragging the thumb
  preventContentHighlight(t) {
    t ? this.targetEl.classList.add("prevent-scroll") : this.targetEl.classList.add("prevent-scroll");
  }
}
E.tag = "onbotgo-customscrollbar";
const T = "onbotgo-chatcontainer";
class S extends g {
  constructor() {
    super();
    n(this, "messagesHistory", [
      {
        message: "¡Hola! ¿En qué puedo ayudarte hoy?",
        type: "apiMessage"
      }
    ]);
    n(this, "scrollableContainer", new h());
    n(this, "messagesContainer", new h());
    n(this, "chatInput", new v());
    n(this, "scrollBar", new E());
    n(this, "defaultStyles", {
      bottom: "60px",
      right: "10px",
      position: "absolute",
      display: "inline-block",
      boxShadow: "rgba(0, 0, 0, 0.16) 0px 5px 40px",
      width: "400px",
      maxHeight: "704px",
      height: "70vh",
      backgroundColor: "white",
      borderRadius: "8px",
      padding: "10px 20px"
    });
    this.classList.add("hidden"), this.setStyles(this.defaultStyles), this.messagesContainer.id = "onbotgo-messageContainer", this.scrollBar["data-target-id"] = "scrollableElement", this.scrollBar.style.visibility = "hidden", this.scrollableContainer.appendChild(this.scrollBar), this.scrollableContainer.appendChild(this.messagesContainer), this.scrollableContainer.setStyles({
      height: "88%",
      position: "relative",
      overflow: "hidden",
      marginBottom: "15px"
    }), this.messagesContainer.setStyles({
      height: "calc(100% - 1.5rem)",
      position: "relative",
      display: "flex",
      flexDirection: "column",
      gap: "15px",
      position: "relative",
      padding: "1rem"
    }), this.chatInput.onSubmit(this.onSubmit.bind(this)), this.appendChild(this.scrollableContainer), this.appendChild(this.chatInput), this.renderMessages(this.messagesHistory);
  }
  onSubmit(t) {
    if (t = t.trim(), !!t)
      try {
        const e = structuredClone(this.messagesHistory);
        e.splice(0, 1);
        const i = {
          history: e,
          question: t
        };
        this.addMessages([{ message: t, type: "userMessage" }]), R(i).then((r) => {
          if (!r.success)
            throw new Error(r.msg);
          r.data.process.length && r.data.process.forEach((a) => {
            this.addMessages([
              {
                message: a.content,
                type: a.role,
                name: a.name
              }
            ]);
          }), this.addMessages([
            { message: r.data.answer, type: "apiMessage" }
          ]);
        });
      } catch {
      }
  }
  toggle() {
    this.classList.contains("hidden") ? (this.scrollBar.style.visibility = "hidden", this.classList.remove("hidden")) : (this.classList.add("hidden"), this.messagesContainer.scrollTop > 0 && (this.scrollBar.style.visibility = "visible"));
  }
  renderMessages(t) {
    t.forEach(
      (e) => !["dataMessage"].includes(e.type) && this.messagesContainer.appendChild(new m(e))
    );
  }
  addMessages(t) {
    this.messagesHistory = this.messagesHistory.concat(t), this.renderMessages(t), this.updateScrollbar();
  }
  updateScrollbar() {
    this.scrollBar.setScrollThumbHeight(), this.messagesContainer.scrollTo(0, this.messagesContainer.scrollHeight), this.messagesContainer.scrollTop > 0 && this.scrollBar.style.visibility === "hidden" && (this.scrollBar.style.visibility = "visible");
  }
}
const q = () => ({
  [`${T}.hidden`]: {
    visibility: "hidden"
    // "-webkit-animation": "onbotgo-bounce-in-fwd 0.7s ease-in both",
    // animation: "onbotgo-bounce-in-fwd 0.7s ease-in both",
  }
}), A = () => ({
  // "@-webkit-keyframes onbotgo-bounce-in-fwd": {
  //   "0%": `{
  //     -webkit-transform: scale(0);
  //             transform: scale(0);
  //     -webkit-animation-timing-function: ease-in;
  //             animation-timing-function: ease-in;
  //     opacity: 0;
  //   }`,
  //   "38%": `{
  //     -webkit-transform: scale(1);
  //             transform: scale(1);
  //     -webkit-animation-timing-function: ease-out;
  //             animation-timing-function: ease-out;
  //     opacity: 1;
  //   }`,
  //   "55%": `{
  //     -webkit-transform: scale(0.7);
  //             transform: scale(0.7);
  //     -webkit-animation-timing-function: ease-in;
  //             animation-timing-function: ease-in;
  //   }`,
  //   "72%": `{
  //     -webkit-transform: scale(1);
  //             transform: scale(1);
  //     -webkit-animation-timing-function: ease-out;
  //             animation-timing-function: ease-out;
  //   }`,
  //   "81%": `{
  //     -webkit-transform: scale(0.84);
  //             transform: scale(0.84);
  //     -webkit-animation-timing-function: ease-in;
  //             animation-timing-function: ease-in;
  //   }`,
  //   "89%": `{
  //     -webkit-transform: scale(1);
  //             transform: scale(1);
  //     -webkit-animation-timing-function: ease-out;
  //             animation-timing-function: ease-out;
  //   }`,
  //   "95%": `{
  //     -webkit-transform: scale(0.95);
  //             transform: scale(0.95);
  //     -webkit-animation-timing-function: ease-in;
  //             animation-timing-function: ease-in;
  //   }`,
  //   "100%": `{
  //     -webkit-transform: scale(1);
  //             transform: scale(1);
  //     -webkit-animation-timing-function: ease-out;
  //             animation-timing-function: ease-out;
  //   }`,
  // },
  // "@keyframes onbotgo-bounce-in-fwd": {
  //   "0%": `{
  //     transform: scale(0);
  //             transform: scale(0);
  //     animation-timing-function: ease-in;
  //             animation-timing-function: ease-in;
  //     opacity: 0;
  //   }`,
  //   "38%": `{
  //     transform: scale(1);
  //             transform: scale(1);
  //     animation-timing-function: ease-out;
  //             animation-timing-function: ease-out;
  //     opacity: 1;
  //   }`,
  //   "55%": `{
  //     transform: scale(0.7);
  //             transform: scale(0.7);
  //     animation-timing-function: ease-in;
  //             animation-timing-function: ease-in;
  //   }`,
  //   "72%": `{
  //     transform: scale(1);
  //             transform: scale(1);
  //     animation-timing-function: ease-out;
  //             animation-timing-function: ease-out;
  //   }`,
  //   "81%": `{
  //     transform: scale(0.84);
  //             transform: scale(0.84);
  //     animation-timing-function: ease-in;
  //             animation-timing-function: ease-in;
  //   }`,
  //   "89%": `{
  //     transform: scale(1);
  //             transform: scale(1);
  //     animation-timing-function: ease-out;
  //             animation-timing-function: ease-out;
  //   }`,
  //   "95%": `{
  //     transform: scale(0.95);
  //             transform: scale(0.95);
  //     animation-timing-function: ease-in;
  //             animation-timing-function: ease-in;
  //   }`,
  //   "100%": `{
  //     transform: scale(1);
  //             transform: scale(1);
  //     animation-timing-function: ease-out;
  //             animation-timing-function: ease-out;
  //   }`,
  // },
});
S.tag = T;
class w extends g {
  constructor() {
    super();
    n(this, "componentStyles", {
      display: "inline-block",
      position: "absolute",
      bottom: "20px",
      right: "20px"
    });
    const t = new C(), e = new S();
    t.onclick = () => e.toggle(), this.appendChild(t), this.appendChild(e), this.setStyles(this.componentStyles);
  }
  connectedCallback() {
  }
}
w.tag = "onbotgo-chatbot";
function W(s, o = {}) {
  const t = Object.keys(o), e = Object.values(o);
  let i = `${s}{`;
  return t.forEach((r, a) => i += `${r}:${e[a]};`), i + "}";
}
function Y(s, o = {}) {
  const t = Object.keys(o), e = Object.values(o);
  let i = `${s}{`;
  return t.forEach((r, a) => i += `${r}${e[a]};`), i + "}";
}
function k(s, o = !1) {
  const t = Object.keys(s);
  let e = "";
  return t.forEach(
    (i) => e += o === "animation" ? Y(
      i,
      s[i]
    ) : W(
      i,
      s[i]
    )
  ), e;
}
function D({ element: s, styles: o, animations: t }) {
  const e = o.reduce(
    (l, c) => ({
      ...l,
      ...c
    }),
    {}
  ), i = t.reduce(
    (l, c) => ({
      ...l,
      ...c
    }),
    {}
  ), r = document.createElement("style"), a = k(i, "animation"), b = k(e);
  r.innerHTML = b + a, s.prepend(r);
}
class P {
  constructor({ chatflow: o, theme: t }) {
    if (x.chatflowID = o, !t)
      return;
    const { typography: e, colors: i } = t;
    e && Object.keys(e).forEach(
      (r) => d.typography[r] = e[r]
    ), i && Object.keys(i).forEach(
      (r) => d.colors[r] = i[r]
    );
  }
  init() {
    this.registerComponents(
      w,
      C,
      S,
      m,
      v,
      h,
      E
    );
    const o = new w();
    D({
      element: o,
      styles: [
        $(d),
        j(d),
        M(d),
        q()
      ],
      animations: [A()]
    }), document.body.appendChild(o);
  }
  registerComponents(...o) {
    o.forEach((t) => customElements.define(t.tag, t));
  }
}
export {
  P as default
};
